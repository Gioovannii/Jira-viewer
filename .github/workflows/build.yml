name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Build app
      run: |
        xcodebuild -project JiraViewer.xcodeproj \
          -scheme JiraViewer \
          -configuration Release \
          -derivedDataPath ./build \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create DMG
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        brew install create-dmg

        # Créer le DMG
        create-dmg \
          --volname "Jira Viewer" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --app-drop-link 425 120 \
          --no-internet-enable \
          "JiraViewer-${{ github.ref_name }}.dmg" \
          "./build/Build/Products/Release/JiraViewer.app" || true

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: JiraViewer-${{ github.sha }}
        path: ./build/Build/Products/Release/JiraViewer.app
        retention-days: 7

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          JiraViewer-${{ github.ref_name }}.dmg
        body: |
          ## Installation

          1. Téléchargez le fichier `.dmg`
          2. Ouvrez-le et glissez JiraViewer dans Applications
          3. Lancez l'application
          4. Allez dans Settings (Cmd+,) pour configurer vos credentials Jira et Claude

          ## Configuration requise

          - macOS 13.0 (Ventura) ou supérieur

          ## Changelog

          Voir les commits pour les changements détaillés.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
