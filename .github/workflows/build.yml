name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Build app
      run: |
        xcodebuild -project JiraViewer.xcodeproj \
          -scheme JiraViewer \
          -configuration Release \
          -derivedDataPath ./build \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create ZIP archive
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd ./build/Build/Products/Release
        zip -r -y ../../../../JiraViewer-${{ github.ref_name }}.zip JiraViewer.app
        cd ../../../../
        ls -lh JiraViewer-*.zip

    - name: Create DMG (optional)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        brew install create-dmg || true

        # CrÃ©er le DMG
        create-dmg \
          --volname "Jira Viewer" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --app-drop-link 425 120 \
          --no-internet-enable \
          "JiraViewer-${{ github.ref_name }}.dmg" \
          "./build/Build/Products/Release/JiraViewer.app" || echo "DMG creation skipped"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: JiraViewer-${{ github.sha }}
        path: ./build/Build/Products/Release/JiraViewer.app
        retention-days: 7

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          JiraViewer-${{ github.ref_name }}.zip
          JiraViewer-${{ github.ref_name }}.dmg
        body: |
          ## ğŸ“¦ Fichiers disponibles

          - **JiraViewer-${{ github.ref_name }}.zip** (RecommandÃ©) - Archive ZIP avec l'application
          - **JiraViewer-${{ github.ref_name }}.dmg** - Image disque DMG

          ## ğŸš€ Installation

          ### Option 1: Avec le ZIP (RecommandÃ©)
          1. TÃ©lÃ©chargez le fichier `.zip`
          2. Double-cliquez pour dÃ©compresser
          3. Glissez `JiraViewer.app` dans votre dossier Applications
          4. Lancez l'application

          ### Option 2: Avec le DMG
          1. TÃ©lÃ©chargez le fichier `.dmg`
          2. Ouvrez-le et glissez JiraViewer dans Applications
          3. Lancez l'application

          **âš ï¸ Note de sÃ©curitÃ©**: Au premier lancement, macOS peut afficher un avertissement car l'app n'est pas signÃ©e. Allez dans **PrÃ©fÃ©rences SystÃ¨me > ConfidentialitÃ© et sÃ©curitÃ©** et cliquez sur **"Ouvrir quand mÃªme"**.

          ## âš™ï¸ Configuration

          1. Ouvrez l'application
          2. Allez dans **Settings** (Cmd+,)
          3. Remplissez vos credentials Jira et Claude API key
          4. C'est parti! ğŸ‰

          ğŸ“– Guide complet: [INSTALLATION_RAPIDE.md](https://github.com/Gioovannii/Jira-viewer/blob/main/INSTALLATION_RAPIDE.md)

          ## ğŸ’» Configuration requise

          - macOS 13.0 (Ventura) ou supÃ©rieur

          ## ğŸ“ Changelog

          Voir les commits pour les changements dÃ©taillÃ©s.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
